name: Frontend CI

on:
  push:
    branches: [fe/develop, fe/production]
  pull_request:
    branches: [fe/develop, fe/production]

defaults:
  run:
    working-directory: ./frontend

jobs:
  type-check:
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        run: npm run type-check

  lint:
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  test:
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        run: npm test
        env:
          CI: true

  build-dev:
    runs-on: ubuntu-latest
    # needs: [type-check, lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:dev

  build-prod:
    runs-on: ubuntu-latest
    needs: [type-check, lint, test]
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:prod

  lighthouse:
    runs-on: ubuntu-latest
    needs: [build-dev]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:dev

      - name: Run Lighthouse CI for Desktop
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          npm install -g @lhci/cli
          lhci collect --config=lighthouserc.cjs || echo 'Fail to Run Lighthouse CI ðŸ’¦'
          lhci upload --config=lighthouserc.cjs || echo 'Fail to Run Lighthouse CI ðŸ’¦'

      - name: Debug Lighthouse Results
        run: |
          echo "=== Checking lighthouse-results directory ==="
          ls -la lighthouse-results/ || echo "lighthouse-results directory not found"
          echo "=== Checking lighthouse-results-mobile directory ==="
          ls -la lighthouse-results-mobile/ || echo "lighthouse-results-mobile directory not found"
          echo "=== Current directory contents ==="
          ls -la

      - name: Run Lighthouse CI for Mobile
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          lhci collect --config=lighthouserc.mobile.cjs || echo 'Fail to Run Lighthouse CI Mobile ðŸ’¦'
          lhci upload --config=lighthouserc.mobile.cjs || echo 'Fail to Run Lighthouse CI Mobile ðŸ’¦'

      - name: Format lighthouse score
        id: format_lighthouse_score
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            process.chdir('./frontend');

            const {
              getLhciPageNameFromUrl,
              LHCI_GREEN_MIN_SCORE,
              LHCI_ORANGE_MIN_SCORE,
              LHCI_RED_MIN_SCORE,
            } = require('./lighthouse.config.cjs');

            const color = (n) => (n >= LHCI_GREEN_MIN_SCORE ? 'ðŸŸ¢' : n >= LHCI_ORANGE_MIN_SCORE ? 'ðŸŸ ' : 'ðŸ”´');
            const pct = (v) => Math.round(v * 100);
            const fmtScore = (n) => `${color(n)}${n}`;
            const fmtAudit = (audit) => {
              if (!audit || typeof audit.score !== 'number') return 'â€”';
              const score100 = Math.round(audit.score * 100);
              return `${color(score100)}${audit.displayValue || ''}`.trim();
            };

            const loadJsons = (dir) =>
              fs.existsSync(dir)
                ? fs
                    .readdirSync(dir)
                    .filter((f) => f.endsWith('.json'))
                    .map((f) => path.join(dir, f))
                    .map((file) => {
                      const report = JSON.parse(fs.readFileSync(file, 'utf8'));
                      return {
                        url: report.finalUrl || report.requestedUrl || report.mainDocumentUrl || '',
                        report,
                      };
                    })
                : [];

            const desktop = loadJsons('lighthouse-results');
            const mobile = loadJsons('lighthouse-results-mobile');

            const monitoringTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const legend = `> ðŸŸ¢: ${LHCI_GREEN_MIN_SCORE}-100 / ðŸŸ : ${LHCI_ORANGE_MIN_SCORE}-${LHCI_GREEN_MIN_SCORE - 1} / ðŸ”´: ${LHCI_RED_MIN_SCORE}-${LHCI_ORANGE_MIN_SCORE - 1}`;

            let comments = `### Lighthouse report âœ¨\n${legend}\n\n`;
            const scores = { desktop: {}, mobile: {} };

            function addTable(results, deviceKey, title) {
              comments += `#### ${title}\n\n`;
              if (results.length === 0) {
                comments += `(ê²°ê³¼ ì—†ìŒ)\n\n`;
                return;
              }

              // í‘œ í—¤ë”(ì¹´í…Œê³ ë¦¬ + í•µì‹¬ ì§€í‘œ)
              comments +=
                `| Page | Perf | A11y | Best | SEO | PWA | FCP | LCP | Speed Index | TBT | CLS |\n` +
                `|------|------|------|------|-----|-----|-----|-----|-------------|-----|-----|\n`;

              for (const { url, report } of results) {
                if (!url) continue;
                const pageUrl = url.replace(/^http:\/\/localhost:\d+/, '');
                const page = getLhciPageNameFromUrl(pageUrl);

                const { categories, audits } = report;

                // ìš”ì•½ ì¹´í…Œê³ ë¦¬ ì ìˆ˜
                const perf = pct(categories.performance.score);
                const a11y = pct(categories.accessibility.score);
                const best = pct(categories['best-practices'].score);
                const seo = pct(categories.seo.score);
                const pwa = categories.pwa ? pct(categories.pwa.score) : 0;

                // í•µì‹¬ ì§€í‘œ (í‘œì‹œê°’ + ìƒ‰ìƒ)
                const FCP = fmtAudit(audits['first-contentful-paint']);
                const LCP = fmtAudit(audits['largest-contentful-paint']);
                const SI = fmtAudit(audits['speed-index']);
                const TBT = fmtAudit(audits['total-blocking-time']);
                const CLS = fmtAudit(audits['cumulative-layout-shift']);

                comments += `| ${page} | ${fmtScore(perf)} | ${fmtScore(a11y)} | ${fmtScore(best)} | ${fmtScore(seo)} | ${fmtScore(pwa)} | ${FCP} | ${LCP} | ${SI} | ${TBT} | ${CLS} |\n`;

                // ìŠ¤í”„ë ˆë“œì‹œíŠ¸/í›„ì²˜ë¦¬ìš© ì›ì‹œ ë°ì´í„°ë„ í•¨ê»˜ ì €ìž¥(í•„ìš”í•˜ë©´ í™œìš©)
                scores[deviceKey][page] = {
                  Performance: fmtScore(perf),
                  Accessibility: fmtScore(a11y),
                  'Best Practices': fmtScore(best),
                  SEO: fmtScore(seo),
                  PWA: fmtScore(pwa),
                  FCP,
                  LCP,
                  'Speed Index': SI,
                  TBT,
                  CLS,
                };
              }

              comments += `\n`; // ì„¹ì…˜ ê°„ ê³µë°±
            }

            addTable(desktop, 'desktop', 'Desktop');
            addTable(mobile, 'mobile', 'Mobile');

            core.setOutput('comments', comments);
            core.setOutput('monitoringTime', monitoringTime);
            core.setOutput('scores', scores);

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: previousComments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const previousLhciComment = previousComments.find((comment) => 
              comment.body.startsWith(`### Lighthouse report âœ¨\n`)
            );

            const newComment = `${{ steps.format_lighthouse_score.outputs.comments }}`;

            if (previousLhciComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previousLhciComment.id,
                body: newComment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: newComment
              });
            }

      - name: Install required packages
        run: npm install google-spreadsheet

      - name: Update Google SpreadSheet
        run: node ./frontend/scripts/update-google-sheet.js
        env:
          LHCI_GOOGLE_CLIENT_EMAIL: ${{ secrets.LHCI_GOOGLE_CLIENT_EMAIL }}
          LHCI_GOOGLE_PRIVATE_KEY: ${{ secrets.LHCI_GOOGLE_PRIVATE_KEY }}
          LHCI_GOOGLE_SPREAD_SHEET_ID: ${{ secrets.LHCI_GOOGLE_SPREAD_SHEET_ID }}
          LHCI_SCORES: ${{ steps.format_lighthouse_score.outputs.scores }}
          LHCI_MONITORING_TIME: ${{ steps.format_lighthouse_score.outputs.monitoringTime }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
