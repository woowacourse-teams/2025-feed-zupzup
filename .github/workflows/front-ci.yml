name: Frontend CI

on:
  push:
    branches: [fe/develop, fe/production]
  pull_request:
    branches: [fe/develop, fe/production]

defaults:
  run:
    working-directory: ./frontend

jobs:
  type-check:
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        run: npm run type-check

  lint:
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  test:
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        run: npm test
        env:
          CI: true

  build-dev:
    runs-on: ubuntu-latest
    # needs: [type-check, lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:dev

  build-prod:
    runs-on: ubuntu-latest
    needs: [type-check, lint, test]
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:prod

  lighthouse:
    runs-on: ubuntu-latest
    needs: [build-dev]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:dev

      - name: Run Lighthouse CI for Desktop
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          npm install -g @lhci/cli
          lhci collect --config=lighthouserc.cjs || echo 'Fail to Run Lighthouse CI ðŸ’¦'
          lhci upload --config=lighthouserc.cjs || echo 'Fail to Run Lighthouse CI ðŸ’¦'

      - name: Debug Lighthouse Results
        run: |
          echo "=== Checking lighthouse-results directory ==="
          ls -la lighthouse-results/ || echo "lighthouse-results directory not found"
          echo "=== Checking lighthouse-results-mobile directory ==="
          ls -la lighthouse-results-mobile/ || echo "lighthouse-results-mobile directory not found"
          echo "=== Current directory contents ==="
          ls -la

      - name: Run Lighthouse CI for Mobile
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          lhci collect --config=lighthouserc.mobile.cjs || echo 'Fail to Run Lighthouse CI Mobile ðŸ’¦'
          lhci upload --config=lighthouserc.mobile.cjs || echo 'Fail to Run Lighthouse CI Mobile ðŸ’¦'

      - name: Format lighthouse score
        id: format_lighthouse_score
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            process.chdir('./frontend');

            const {
              getLhciPageNameFromUrl,
              LHCI_GREEN_MIN_SCORE,
              LHCI_ORANGE_MIN_SCORE,
              LHCI_RED_MIN_SCORE,
            } = require('./lighthouse.config.cjs');

            const getColor = (score) => {
              if (score >= LHCI_GREEN_MIN_SCORE) return 'ðŸŸ¢';
              else if (score >= LHCI_ORANGE_MIN_SCORE) return 'ðŸŸ ';
              return 'ðŸ”´';
            };
            const fmtScore = (n) => `${getColor(n)}${n}`;
            const pct = (v) => Math.round(v * 100);

            const desktopResultsDir = 'lighthouse-results';
            const mobileResultsDir = 'lighthouse-results-mobile';

            const loadResults = (dir) => {
              if (!fs.existsSync(dir)) return [];
              return fs.readdirSync(dir)
                .filter((f) => f.endsWith('.json'))
                .map((f) => path.join(dir, f))
                .map((file) => {
                  const content = JSON.parse(fs.readFileSync(file, 'utf8'));
                  return {
                    url: content.finalUrl || content.requestedUrl || content.mainDocumentUrl || '',
                    report: content,
                  };
                });
            };

            const desktopResults = loadResults(desktopResultsDir);
            const mobileResults = loadResults(mobileResultsDir);

            const monitoringTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const scoreDescription =
              `> ðŸŸ¢: ${LHCI_GREEN_MIN_SCORE} - 100 / ðŸŸ : ${LHCI_ORANGE_MIN_SCORE} - ${LHCI_GREEN_MIN_SCORE - 1} / ðŸ”´: ${LHCI_RED_MIN_SCORE} - ${LHCI_ORANGE_MIN_SCORE - 1}`;

            let comments = `### Lighthouse report âœ¨\n${scoreDescription}\n\n`;
            const scores = { desktop: {}, mobile: {} };

            const buildSummaryTable = (results, deviceKey, deviceTitle) => {
              if (results.length === 0) {
                comments += `#### ${deviceTitle}\n\n(ê²°ê³¼ ì—†ìŒ)\n\n`;
                return;
              }

              // í‘œ í—¤ë”
              const header =
                `#### ${deviceTitle}\n\n` +
                `| Page | Perf | A11y | Best | SEO | PWA |\n` +
                `|------|------|------|------|-----|-----|\n`;

              let rows = '';

              results.forEach(({ url, report }) => {
                if (!url) return;

                const pageUrl = url.replace(/^http:\/\/localhost:\d+/, '');
                const pageName = getLhciPageNameFromUrl(pageUrl);
                const { categories } = report;

                const summary = {
                  performance: pct(categories.performance.score),
                  accessibility: pct(categories.accessibility.score),
                  'best-practices': pct(categories['best-practices'].score),
                  seo: pct(categories.seo.score),
                  pwa: categories.pwa ? pct(categories.pwa.score) : 0,
                };

                // PR ì½”ë©˜íŠ¸ í‘œ í–‰
                rows += `| ${pageName} | ${fmtScore(summary.performance)} | ${fmtScore(summary.accessibility)} | ${fmtScore(summary['best-practices'])} | ${fmtScore(summary.seo)} | ${fmtScore(summary.pwa)} |\n`;

                // êµ¬ê¸€ ì‹œíŠ¸/í›„ì²˜ë¦¬ë¥¼ ìœ„í•œ ì›ì‹œ ì ìˆ˜ë„ ìœ ì§€
                scores[deviceKey][pageName] = {
                  Performance: fmtScore(summary.performance),
                  Accessibility: fmtScore(summary.accessibility),
                  'Best Practices': fmtScore(summary['best-practices']),
                  SEO: fmtScore(summary.seo),
                  PWA: fmtScore(summary.pwa),
                };
              });

              comments += header + rows + `\n`;
            };

            buildSummaryTable(desktopResults, 'desktop', 'Desktop');
            buildSummaryTable(mobileResults, 'mobile', 'Mobile');

            core.setOutput('comments', comments);
            core.setOutput('monitoringTime', monitoringTime);
            core.setOutput('scores', scores);

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: previousComments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const previousLhciComment = previousComments.find((comment) => 
              comment.body.startsWith(`### Lighthouse report âœ¨\n`)
            );

            const newComment = `${{ steps.format_lighthouse_score.outputs.comments }}`;

            if (previousLhciComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previousLhciComment.id,
                body: newComment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: newComment
              });
            }

      - name: Install required packages
        run: npm install google-spreadsheet

      - name: Update Google SpreadSheet
        run: node ./frontend/scripts/update-google-sheet.js
        env:
          LHCI_GOOGLE_CLIENT_EMAIL: ${{ secrets.LHCI_GOOGLE_CLIENT_EMAIL }}
          LHCI_GOOGLE_PRIVATE_KEY: ${{ secrets.LHCI_GOOGLE_PRIVATE_KEY }}
          LHCI_GOOGLE_SPREAD_SHEET_ID: ${{ secrets.LHCI_GOOGLE_SPREAD_SHEET_ID }}
          LHCI_SCORES: ${{ steps.format_lighthouse_score.outputs.scores }}
          LHCI_MONITORING_TIME: ${{ steps.format_lighthouse_score.outputs.monitoringTime }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
