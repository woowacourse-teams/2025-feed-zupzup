name: Discord Notification

on:
  pull_request:
    types: [opened, reopened, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          WEBHOOK_FRONTEND: ${{ secrets.DISCORD_WEBHOOK_FRONTEND }}
          WEBHOOK_BACKEND: ${{ secrets.DISCORD_WEBHOOK_BACKEND }}
        run: |
          # ì´ë²¤íŠ¸ íƒ€ìž…ì— ë”°ë¼ ë°ì´í„° ì¶”ì¶œ
          if [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            echo "Processing review event..."
          
            # ë¦¬ë·° ì´ë²¤íŠ¸ - APIë¡œ PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.event.review.pull_request_url }}")
          
            LABELS=$(echo "$PR_DATA" | jq -r '.labels[]?.name // empty' | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
            TITLE=$(echo "$PR_DATA" | jq -r '.title // "Unknown"' | sed 's/"/\\"/g')
            URL=$(echo "$PR_DATA" | jq -r '.html_url // ""')
            AUTHOR="${{ github.event.review.user.login }}"
            TYPE="Code Review"
          
            # ë¦¬ë·° ìƒíƒœë³„ ì„¤ì •
            case "${{ github.event.review.state }}" in
              "approved") 
                ACTION="approved"
                COLOR=3066993 ;;
              "changes_requested") 
                ACTION="requested changes"
                COLOR=15158332 ;;
              "commented") 
                ACTION="commented"
                COLOR=3447003 ;;
              *) 
                ACTION="reviewed"
                COLOR=3447003 ;;
            esac
          else
            echo "Processing pull request event..."
          
            # PR ì´ë²¤íŠ¸
            LABELS=$(echo '${{ toJson(github.event.pull_request.labels) }}' | jq -r '.[].name // empty' | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
            TITLE=$(echo '${{ github.event.pull_request.title }}' | sed 's/"/\\"/g')
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            TYPE="Pull Request"
            COLOR=5814783
          
            # PR ì•¡ì…˜ ì²˜ë¦¬
            if [[ "${{ github.event.action }}" == "closed" ]]; then
              if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
                ACTION="merged"
                COLOR=8663711
              else
                ACTION="closed"
                COLOR=6710886
              fi
            else
              ACTION="${{ github.event.action }}"
            fi
          fi
          
          # ë¹ˆ ë¼ë²¨ ì²˜ë¦¬
          if [[ -z "$LABELS" ]]; then
            LABELS="No labels"
          fi
          
          echo "Labels: $LABELS"
          echo "Action: $ACTION"
          
          # ë¼ë²¨ì— ë”°ë¼ ì›¹í›… ì„ íƒ
          WEBHOOK_URL=""
          CHANNEL=""
          
          if echo "$LABELS" | grep -q "ðŸ§backend"; then
            WEBHOOK_URL="$WEBHOOK_BACKEND"
            CHANNEL="backend"
          elif echo "$LABELS" | grep -q "ðŸ¤frontend"; then
            WEBHOOK_URL="$WEBHOOK_FRONTEND"
            CHANNEL="frontend"
          else
            echo "No relevant labels found (ðŸ¤frontend/ðŸ§backend), skipping notification"
            exit 0
          fi
          
          # ì›¹í›… URL ì²´í¬
          if [[ -z "$WEBHOOK_URL" ]]; then
            echo "Webhook URL not configured for $CHANNEL channel"
            exit 1
          fi
          
          # Discord ë©”ì‹œì§€ ìƒì„± (JSONì„ í•œ ì¤„ë¡œ)
          MESSAGE='{"username":"GitHub Bot","avatar_url":"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png","embeds":[{"title":"'$TYPE' '$ACTION'","description":"**'$TITLE'**","url":"'$URL'","color":'$COLOR',"fields":[{"name":"Author","value":"'$AUTHOR'","inline":true},{"name":"Labels","value":"'$LABELS'","inline":true},{"name":"Channel","value":"'$CHANNEL'","inline":true}],"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"}]}'
          
          echo "Sending to $CHANNEL channel..."
          
          # Discordë¡œ ì „ì†¡
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/response.json \
            -H "Content-Type: application/json" \
            -d "$MESSAGE" \
            "$WEBHOOK_URL")
          
          if [[ "$HTTP_CODE" == "204" ]]; then
            echo "âœ… Successfully sent to $CHANNEL"
          else
            echo "âŒ Failed to send notification. HTTP: $HTTP_CODE"
            echo "Response: $(cat /tmp/response.json 2>/dev/null || echo 'No response')"
            exit 1
          fi
