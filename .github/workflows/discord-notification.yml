name: Discord Notification

on:
  pull_request:
    types: [opened, reopened, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          # PR ì´ë²¤íŠ¸ìš© ë°ì´í„° ë¯¸ë¦¬ ì¶”ì¶œ
          PR_LABELS: ${{ toJson(github.event.pull_request.labels) }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_MERGED: ${{ github.event.pull_request.merged }}

          # ë¦¬ë·° ì´ë²¤íŠ¸ìš© ë°ì´í„°
          REVIEW_STATE: ${{ github.event.review.state }}
          REVIEW_AUTHOR: ${{ github.event.review.user.login }}
          REVIEW_PR_URL: ${{ github.event.review.pull_request_url }}

          # ì›¹í›… URLs
          WEBHOOK_FRONTEND: ${{ secrets.DISCORD_WEBHOOK_FRONTEND }}
          WEBHOOK_BACKEND: ${{ secrets.DISCORD_WEBHOOK_BACKEND }}

        run: |
          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ì²˜ë¦¬
          if [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            # ë¦¬ë·° ì´ë²¤íŠ¸ - APIë¡œ PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            echo "Processing review event..."
          
            PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$REVIEW_PR_URL")
            LABELS=$(echo "$PR_DATA" | jq -r '.labels | map(.name) | join(", ")')
            TITLE=$(echo "$PR_DATA" | jq -r '.title')
            URL=$(echo "$PR_DATA" | jq -r '.html_url')
            AUTHOR="$REVIEW_AUTHOR"
            TYPE="Code Review"
          
            # ë¦¬ë·° ìƒíƒœì— ë”°ë¥¸ ì•¡ì…˜ ë° ìƒ‰ìƒ
            case "$REVIEW_STATE" in
              "approved") 
                ACTION="approved"
                COLOR=3066993 ;;      # ì´ˆë¡ìƒ‰
              "changes_requested") 
                ACTION="requested changes"
                COLOR=15158332 ;;     # ë¹¨ê°„ìƒ‰
              "commented") 
                ACTION="commented"
                COLOR=3447003 ;;      # íŒŒë€ìƒ‰
              *) 
                ACTION="reviewed"
                COLOR=3447003 ;;      # íŒŒë€ìƒ‰
            esac
          
          else
            # PR ì´ë²¤íŠ¸
            echo "Processing pull request event..."
          
            LABELS=$(echo "$PR_LABELS" | jq -r 'map(.name) | join(", ")')
            TITLE="$PR_TITLE"
            URL="$PR_URL"
            AUTHOR="$PR_AUTHOR"
            TYPE="Pull Request"
            COLOR=5814783  # ê¸°ë³¸ ë³´ë¼ìƒ‰
          
            # PR ì•¡ì…˜ ì²˜ë¦¬ (merged ì—¬ë¶€ êµ¬ë¶„)
            if [[ "${{ github.event.action }}" == "closed" ]]; then
              if [[ "$PR_MERGED" == "true" ]]; then
                ACTION="merged"
              else
                ACTION="closed"
              fi
            else
              ACTION="${{ github.event.action }}"
            fi
          fi
          
          echo "Labels: $LABELS"
          echo "Action: $ACTION"
          
          # ë¼ë²¨ì— ë”°ë¼ ì›¹í›… URL ì„ íƒ
          WEBHOOK_URL=""
          if echo "$LABELS" | grep -q "ğŸ¤frontend"; then
            WEBHOOK_URL="$WEBHOOK_FRONTEND"
            CHANNEL="frontend"
          elif echo "$LABELS" | grep -q "ğŸ§backend"; then
            WEBHOOK_URL="$WEBHOOK_BACKEND"
            CHANNEL="backend"
          else
            echo "No relevant labels found (ğŸ¤frontend/ğŸ§backend), skipping notification"
            exit 0
          fi
          
          # ì›¹í›… URL ì¡´ì¬ ì—¬ë¶€ ì²´í¬
          if [[ -z "$WEBHOOK_URL" ]]; then
            echo "Webhook URL not set for $CHANNEL channel. Please check secrets."
            exit 1
          fi
          
          # ë©”ì‹œì§€ êµ¬ì„±
          MESSAGE=$(cat <<EOF
          {
            "embeds": [{
              "title": "$TYPE $ACTION",
              "description": "**$TITLE**",
              "url": "$URL",
              "color": $COLOR,
              "fields": [
                {"name": "Author", "value": "$AUTHOR", "inline": true},
                {"name": "Labels", "value": "$LABELS", "inline": true},
                {"name": "Channel", "value": "$CHANNEL", "inline": true}
              ]
            }]
          }
          EOF
          )
          
          # ë””ìŠ¤ì½”ë“œë¡œ ì „ì†¡
          echo "Sending notification to $CHANNEL channel..."
          
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/discord_response \
            -H "Content-Type: application/json" \
            -d "$MESSAGE" \
            "$WEBHOOK_URL")
          
          if [[ "$RESPONSE" == "204" ]]; then
            echo "âœ… Successfully sent notification to $CHANNEL channel"
          else
            echo "âŒ Failed to send notification. HTTP status: $RESPONSE"
            echo "Response: $(cat /tmp/discord_response)"
            exit 1
          fi
